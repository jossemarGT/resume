---
# .github/workflows/default.yml

name: Generate resume artifacts
on: push
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build environment setup
        run: |
          ./build.sh ci-setup
          ./build.sh bump-date
      - uses: docker://pandoc/latex:2.9
        name: Generate HTML resume
        with:
          args: >-
            --verbose --fail-if-warnings --standalone --wrap=none --section-divs --no-highlight
            --from markdown_github+yaml_metadata_block+auto_identifiers+smart-hard_line_breaks
            --to html5 --template docs/resume.template --output docs/index.html
            ./RESUME.md docs/configuration.yaml
      - uses: docker://madnight/docker-alpine-wkhtmltopdf
        name: Generate PDF resume
        with:
          args: >-
            --page-size Letter --no-background --print-media-type
            --user-style-sheet docs/stylesheets/wkhtmltopdf.css -T 20 -R 13 -B 13 -L 13
            docs/index.html dist/jossemargt-resume.pdf
      - uses: actions/upload-artifact@v2
        with:
          name: built-resume
          retention-days: 1
          path: |
            dist/*.pdf
            docs/
  release:
    needs: build
    if:  ${{ contains(github.ref, 'master') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Download latest artifacts
        uses: actions/download-artifact@v2
        with:
          name: built-resume
          path: dist
      - name: Pre-Release
        run: |
          ./build.sh ci-setup
          cp dist/docs/index.html docs/index.html
          ./build.sh ci-gh-page-bump
      - name: Publish PDF
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          automatic_release_tag: latest
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          files: |
            dist/dist/*.pdf
      - name: Plubish GH Pages
        run: |
          ./build.sh ci-gh-page-publish
